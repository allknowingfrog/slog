<!DOCTYPE html>
<html lang="en">
<head>
<title>Slog</title>
<meta charset="utf-8">
<style>
body {
    background: gray;
}
canvas {
    display: block;
    margin: auto;
    background: black;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io.connect();

var canvas;
var CANVAS_W;
var CANVAS_H;
var ctx;

var TILE_W;
var TILE_H;

var VIEW_RANGE;
var view;
var dirs;

var keyBind;

//dvorak homerow
var dvorak = {
    nw: 44, //,
    n: 46, //.
    ne: 112, //p
    se: 117, //u
    s: 101, //e
    sw: 111, //a
    action: 32, //space
    land: 49, //1
    water: 50, //2
    wall: 51, //3
    cave: 52 //4
};

//qwerty homerow
var qwerty = {
    nw: 119, //w
    n: 101, //e
    ne: 114, //r
    se: 102, //f
    s: 100, //d
    sw: 115, //s
    action: 32, //space
    land: 49, //1
    water: 50, //2
    wall: 51, //3
    cave: 52 //4
};

var tiles = {
    player: new Image(),
    land: new Image(),
    water: new Image(),
    wall: new Image(),
    cave: new Image(),
    red: new Image()
};
tiles.player.src = 'player.svg';
tiles.land.src = 'greenHex.svg';
tiles.water.src = 'blueHex.svg';
tiles.wall.src = 'grayHex.svg';
tiles.cave.src = 'brownHex.svg';
tiles.red.src = 'redHex.svg';

function keyPress(key) {
    for(var k in keyBind) {
        if(keyBind[k] == key) {
            socket.emit('keyPress', k); 
            break;
        }
    }
}

//init functions
function init(data) {
    VIEW_RANGE = data.VIEW_RANGE;
    dirs = data.dirs;
    view = data.view;

    keyBind = dvorak;

    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');

    setCanvasWidth(600);

    $(document).keypress(function(e) {
        e.preventDefault();
        keyPress(e.which);
    }); 
}

function setCanvasWidth(width) {
    CANVAS_W = width;
    TILE_W = CANVAS_W / (2 + (.75 * VIEW_RANGE * 2));
    TILE_H = Math.sqrt(3)/2 * TILE_W;
    CANVAS_H = TILE_H * 2 * (VIEW_RANGE + 1);
    canvas.width = CANVAS_W;
    canvas.height = CANVAS_H;
    return "canvas width set: " + width;
}

function setQwerty(toggle) {
    if(toggle) {
        keyBind = qwerty;
        return 'keybinding set to qwerty';
    } else {
        keyBind = dvorak;
        return 'keybinding set to dvorak';
    }
}

function draw() {
    var xStart = (CANVAS_W / 2) - (TILE_W / 2);
    var yStart = (CANVAS_H / 2) - (TILE_H / 2);
    var origin = Math.floor(view.length/2);
    var terrain, player, xRel, yRel, xDraw, yDraw;
    ctx.clearRect(0, 0, CANVAS_W, CANVAS_H);
    for(var x=0; x<view.length; x++) {
        for(var y=0; y<view.length; y++) {
            terrain = view[x][y].terrain;
            if(terrain) {
                xRel = x - origin;
                yRel = y - origin;
                xDraw = xStart + (xRel * (.75 * TILE_W)); 
                yDraw = yStart + ((yRel - (xRel / 2)) * TILE_H); 
                ctx.drawImage(tiles[terrain], xDraw, yDraw, TILE_W, TILE_H);
                if(view[x][y].player) {
                    ctx.drawImage(tiles.player, xDraw, yDraw, TILE_W, TILE_H);
                }
            }
        }
    }
}

//start game
$(document).ready(function() {
    $('#login').submit(function(e) {
        e.preventDefault();
        socket.emit('login', $('#nickname').val(), function(data) {
            if(data) {
                $('#loginDiv').hide();
                $('#gameDiv').show();
                init(data);
            } else {
                $('#output').html('That username is already taken! Try again.');
            }
        });
        $('#nickname').val('');
    });
    socket.on('update', function(data) {
        view = data;
        draw();
    });
});
</script>
</head>
<body>

<div id="loginDiv" style="margin:50px;">
    <div style='float:left;'>Enter a username:</div>
    <form id="login">
        <input style="width:150px;" id="nickname">
        <input type="submit">
    </form>
</div>

<div id="gameDiv" style="width:100%;display:none;">
    <div style="margin:50px;">
        <div style="float:left;margin-right:15px;"><canvas id="canvas"></canvas></div>
        <div id="sidebar"></div>
    </div>
</div>

<div id="output" style='width:100%;'></div>

</body>
</html>
